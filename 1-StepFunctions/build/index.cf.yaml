AWSTemplateFormatVersion: '2010-09-09'
Description: Step Function Examples
Globals:
  Function:
    Environment:
      Variables:
        ENV:
          Ref: Env
        REGION:
          Ref: AWS::Region
        SERVICE_NAME:
          Ref: ServiceName
    MemorySize: 128
    Runtime: nodejs8.10
    Timeout: 30
Outputs:
  GetWelcome:
    Export:
      Name:
        Fn::Sub: ${ServiceName}-${Env}-GetWelcome
    Value:
      Fn::GetAtt:
      - GetWelcome
      - Arn
  LambdaServiceRole:
    Export:
      Name:
        Fn::Sub: ${ServiceName}-${Env}-LambdaServiceRole
    Value:
      Fn::GetAtt:
      - LambdaServiceRole
      - Arn
Parameters:
  Env:
    Description: The environment name. e.g. dev, prod.
    Type: String
  ServiceName:
    Default: sf-examples
    Description: The service name.
    Type: String
Resources:
  GetWelcome:
    Properties:
      CodeUri: s3://h4-sandpit-tmp/0b37877fd11d8cda66866f3176390341
      Handler: src/handler.getWelcome
      Role:
        Fn::GetAtt:
        - LambdaServiceRole
        - Arn
    Type: AWS::Serverless::Function
  GetWelcomeEndpoint:
    Properties:
      CodeUri: s3://h4-sandpit-tmp/0b37877fd11d8cda66866f3176390341
      Events:
        HttpPost:
          Properties:
            Method: get
            Path: /welcome/direct
          Type: Api
      Handler: src/handler.getWelcomeHttp
      Role:
        Fn::GetAtt:
        - LambdaServiceRole
        - Arn
    Type: AWS::Serverless::Function
  GetWelcomeWithRetry:
    Properties:
      CodeUri: s3://h4-sandpit-tmp/0b37877fd11d8cda66866f3176390341
      Environment:
        Variables:
          WELCOME_RETRY_STATE_MACHINE:
            Ref: WelcomeRetryStateMachine
          WELCOME_STATE_MACHINE:
            Ref: WelcomeStateMachine
      Events:
        HttpPost:
          Properties:
            Method: get
            Path: /welcome/retry
          Type: Api
      Handler: src/handler.getWelcomeWithRetry
      Role:
        Fn::GetAtt:
        - LambdaServiceRole
        - Arn
    Type: AWS::Serverless::Function
  LambdaServiceRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
        Version: '2012-10-17'
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - Ref: StatesPolicy
    Type: AWS::IAM::Role
  MyActivity:
    Properties:
      Name:
        Fn::Sub: ${Env}MyActivity
    Type: AWS::StepFunctions::Activity
  MyActivityStateMachine:
    Properties:
      Fn::Transform:
        Name: AWS::Include
        Parameters:
          Location: s3://h4-sandpit-tmp/31f0b3227dfadd2e2dda26ddd1a92346
    Type: AWS::StepFunctions::StateMachine
  StateMachineRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
              Fn::Sub: states.${AWS::Region}.amazonaws.com
        Version: '2012-10-17'
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - lambda:InvokeFunction
            Effect: Allow
            Resource: '*'
          Version: '2012-10-17'
        PolicyName: WelcomeStateMachinePolicy
    Type: AWS::IAM::Role
  StatesPolicy:
    Properties:
      PolicyDocument:
        Statement:
        - Action:
          - states:DescribeExecution
          - states:StartExecution
          Effect: Allow
          Resource: '*'
        Version: '2012-10-17'
    Type: AWS::IAM::ManagedPolicy
  WakeStack2:
    Properties:
      Parameters:
        Env:
          Ref: Env
        ServiceName:
          Ref: ServiceName
        StateMachineRoleArn:
          Fn::GetAtt:
          - StateMachineRole
          - Arn
      TemplateURL: https://s3.amazonaws.com/h4-sandpit-tmp/eb8c5cff3c9069ea8429f5fcd9190725.template
    Type: AWS::CloudFormation::Stack
  WelcomeRetryStateMachine:
    Properties:
      Fn::Transform:
        Name: AWS::Include
        Parameters:
          Location: s3://h4-sandpit-tmp/8511fe837abe298033d99c5aef61fd1e
    Type: AWS::StepFunctions::StateMachine
  WelcomeStateMachine:
    Properties:
      Fn::Transform:
        Name: AWS::Include
        Parameters:
          Location: s3://h4-sandpit-tmp/2bccb618cd765068b6a50574afe51bd4
    Type: AWS::StepFunctions::StateMachine
  WelcomeTryCatchBulkStateMachine:
    Properties:
      Fn::Transform:
        Name: AWS::Include
        Parameters:
          Location: s3://h4-sandpit-tmp/ca560455555c3473fe0640c9e19991d0
    Type: AWS::StepFunctions::StateMachine
  WelcomeTryCatchStateMachine:
    Properties:
      Fn::Transform:
        Name: AWS::Include
        Parameters:
          Location: s3://h4-sandpit-tmp/f6d605f7aeb8510234774c4ca9878d19
    Type: AWS::StepFunctions::StateMachine
Transform: AWS::Serverless-2016-10-31
